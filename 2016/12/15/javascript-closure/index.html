<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Javascript closure | Tri&#39;s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Closure一直是我覺得JS裡面很玄的東西，最近又熊熊想到(?)回去好好看它，這篇主要是記錄自己卡點的地方，如果有錯歡迎指正。">
<meta property="og:type" content="article">
<meta property="og:title" content="Javascript closure">
<meta property="og:url" content="http://tri613.github.io/2016/12/15/javascript-closure/index.html">
<meta property="og:site_name" content="Tri's">
<meta property="og:description" content="Closure一直是我覺得JS裡面很玄的東西，最近又熊熊想到(?)回去好好看它，這篇主要是記錄自己卡點的地方，如果有錯歡迎指正。">
<meta property="og:updated_time" content="2017-06-20T05:20:50.751Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Javascript closure">
<meta name="twitter:description" content="Closure一直是我覺得JS裡面很玄的東西，最近又熊熊想到(?)回去好好看它，這篇主要是記錄自己卡點的地方，如果有錯歡迎指正。">
    

    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                
                <span class="site-title">Tri&#39;s</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="https://avatars0.githubusercontent.com/u/10163715?v=3&amp;s=400" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜尋" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: 'Pages',
            CATEGORIES: '分類',
            TAGS: '標籤',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜尋" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="https://avatars0.githubusercontent.com/u/10163715?v=3&amp;s=400" />
            <h2 id="name">Trina Lu</h2>
            <h3 id="title">寫點筆記 &amp; murmur</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Taipei, Taiwan</span>
            <a id="follow" target="_blank" href="https://github.com/tri613">關注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                10
                <span>文章</span>
            </div>
            <div class="article-info-block">
                15
                <span>標籤</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/tri613" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://twitter.com/tri613" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://www.facebook.com/trina.lu.1" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-javascript-closure" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            Javascript closure
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/12/15/javascript-closure/">
            <time datetime="2016-12-15T04:50:54.000Z" itemprop="datePublished">2016-12-15</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/javascript/">javascript</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>Closure一直是我覺得JS裡面很玄的東西，<br>最近又熊熊想到(?)回去好好看它，<br>這篇主要是記錄自己卡點的地方，如果有錯歡迎指正。</p>
<a id="more"></a>
<h2 id="定義"><a href="#定義" class="headerlink" title="定義"></a>定義</h2><blockquote><p>Closures are functions that refer to independent (free) variables (variables that are used locally, but defined in an enclosing scope). In other words, these functions ‘remember’ the environment in which they were created.</p>
<footer><strong>Mozilla</strong><cite><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures" target="_blank" rel="external">developer.mozilla.org/en-US/docs/Web/JavaScript/Closures</a></cite></footer></blockquote>
<blockquote><p>Closures can simply be defined as an inner function in JavaScript has the access to all variable define in outer functions.<br>So when a function is invoked in JavaScript , it creates a new execution context. This context has access to Parent objects with the arguments for current function get invoked, this execution context also has access to the variables declared outside of its scope.</p>
<footer><strong>Programming Concepts Help</strong><cite><a href="http://conceptf1.blogspot.tw/2013/11/javascript-closures.html" target="_blank" rel="external">conceptf1.blogspot.tw/2013/11/javascript-closures.html</a></cite></footer></blockquote>
<p>考慮以下的例子：</p>
<iframe scrolling="no" width="100%" height="300" src="http://jsfiddle.net/rLhfxgo7/embedded/js,result/dark" frameborder="0" allowfullscreen></iframe>
<p><code>greeting</code> 被賦值的時候，會觸發並執行 anonymous function，<br>這個anonymous function則會回傳另一個function。<br>而這個function，也就是閉包，它記住了它的環境上下文，<br>所以它可以取得在它scope之外的變數 <code>me</code>，<br>即使 <code>me</code> 的值被改變，<code>greeting</code>仍然可以取得 <code>me</code> 正確的值。</p>
<p>這就是一個最簡單的closure。</p>
<h2 id="Creating-closures-in-loops-A-common-mistake"><a href="#Creating-closures-in-loops-A-common-mistake" class="headerlink" title="Creating closures in loops: A common mistake"></a>Creating closures in loops: A common mistake</h2><p>Mozilla關於Closure的文件上有一段<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures#Creating_closures_in_loops_A_common_mistake" target="_blank" rel="external">Creating closures in loops: A common mistake</a>，<br>裡面的例子我卡了很久才想通：(這邊是直接用Mozilla上面的fiddle)</p>
<iframe scrolling="no" width="100%" height="300" src="http://jsfiddle.net/v7gjv/embedded/js,html,result/dark" frameborder="0" allowfullscreen></iframe>
<p>照理來說，我們希望在focus不同input的時候，會出現各自的提示訊息，<br>但這邊卻只會顯示最後一筆 <code>Your age (you must be over 16)</code>。<br>原因是在創建onfocus的callback的時候，它其實是一個closure，<br>所以它記得的是被創建時的<strong>上下文</strong>，<br>也就是說onfocus被觸發的時候，它的callback會知道去哪裡找 <code>item.help</code> 的值，<br>但在for loop完了之後，<code>item.help</code>的值已經變成 <code>Your age (you must be over 16)</code>了，<br>而這也是為什麼上面的範例中，不管選哪個它都只會顯示同一個訊息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; helpText.length; i++) &#123;</div><div class="line">    <span class="keyword">var</span> item = helpText[i];</div><div class="line">    <span class="built_in">document</span>.getElementById(item.id).onfocus = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      showHelp(item.help); </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 在for loop外面印出item</span></div><div class="line"><span class="built_in">console</span>.log(item); <span class="comment">// &#123;'id': 'age', 'help': 'Your age (you must be over 16)'&#125;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>所以說Closure基本上就是一個inner function會記得被創建時的外層上下文環境，<br>而這個inner function可以取得parent scope的變數，<br>它知道變數該指向的<code>對象</code>，但並不包含變數當下的<code>值</code>。</p>
</blockquote>
<h2 id="Creating-closures-in-loops-Solutions"><a href="#Creating-closures-in-loops-Solutions" class="headerlink" title="Creating closures in loops: Solutions"></a>Creating closures in loops: Solutions</h2><p>解法在 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures#Creating_closures_in_loops_A_common_mistake" target="_blank" rel="external">Mozilla</a> 上面都有提供，這邊稍微再補充那裡面提到的第一種方式。</p>
<iframe scrolling="no" width="100%" height="300" src="http://jsfiddle.net/v7gjv/1/embedded/js,html,result/dark" frameborder="0" allowfullscreen></iframe>
<p>根據 Mozilla 的說明，之前 for loop 會出問題，是因為所有的callback function在創建時，<br>全部都指向了同一個環境，所以指向的<code>item</code>都會是同一個，<br>不像上面是各自創了一個獨立環境。</p>
<p>這個說法對我來說有點抽象，我比較喜歡<a href="http://conceptf1.blogspot.tw/2013/11/javascript-closures.html" target="_blank" rel="external">Programming Concepts Help</a>的解釋：</p>
<blockquote>
<p>If we pass a parameter function makes its own local copy of the variable (if it is not object type which pass by reference). So each time function has its own local copy of variable which not get updated by loop iteration.</p>
</blockquote>
<p>豁然開朗啊！JS真是博大精深。(謎)</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures" target="_blank" rel="external">Mozilla - Closures</a></li>
<li><a href="http://conceptf1.blogspot.tw/2013/11/javascript-closures.html" target="_blank" rel="external">Programming Concepts Help</a></li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://tri613.github.io/2016/12/15/javascript-closure/" data-id="cj455agox0005pwhg6ppd8jq6" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://tri613.github.io/2016/12/15/javascript-closure/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://tri613.github.io/2016/12/15/javascript-closure/">評論</a>
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2017/01/12/safari-click-event/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    Click events not working on Safari
                
            </div>
        </a>
    
    
        <a href="/2016/11/23/google-login/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">Setup Google login</div>
        </a>
    
</nav>


    
</article>


    
    
        <section id="comments">
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>
    

</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/06/15/bind-apply-and-call/" class="title">.bind(), .apply() and .call()</a></p>
                            <p class="item-date"><time datetime="2017-06-15T06:25:31.000Z" itemprop="datePublished">2017-06-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/01/23/by-value-and-by-reference/" class="title">Javascript&#39;s by value and by reference</a></p>
                            <p class="item-date"><time datetime="2017-01-22T16:26:39.000Z" itemprop="datePublished">2017-01-23</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/01/12/safari-click-event/" class="title">Click events not working on Safari</a></p>
                            <p class="item-date"><time datetime="2017-01-12T15:54:29.000Z" itemprop="datePublished">2017-01-12</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2016/12/15/javascript-closure/" class="title">Javascript closure</a></p>
                            <p class="item-date"><time datetime="2016-12-15T04:50:54.000Z" itemprop="datePublished">2016-12-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2016/11/23/google-login/" class="title">Setup Google login</a></p>
                            <p class="item-date"><time datetime="2016-11-23T05:53:46.000Z" itemprop="datePublished">2016-11-23</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">歸檔</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">6</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">標籤</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/apns/">apns</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google/">google</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i-dont-know-JS/">i-dont-know-JS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ie/">ie</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ios/">ios</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mamp/">mamp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/osx/">osx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/push/">push</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/safari/">safari</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/social-login/">social-login</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vm/">vm</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">標籤雲</h3>
        <div class="widget tagcloud">
            <a href="/tags/apns/" style="font-size: 10px;">apns</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/google/" style="font-size: 10px;">google</a> <a href="/tags/i-dont-know-JS/" style="font-size: 10px;">i-dont-know-JS</a> <a href="/tags/ie/" style="font-size: 10px;">ie</a> <a href="/tags/ios/" style="font-size: 15px;">ios</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/mamp/" style="font-size: 10px;">mamp</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/osx/" style="font-size: 10px;">osx</a> <a href="/tags/push/" style="font-size: 10px;">push</a> <a href="/tags/safari/" style="font-size: 10px;">safari</a> <a href="/tags/social-login/" style="font-size: 10px;">social-login</a> <a href="/tags/vm/" style="font-size: 10px;">vm</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">連結</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 Trina Lu<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
            this.page.url = 'http://tri613.github.io/2016/12/15/javascript-closure/';
        
        this.page.identifier = 'javascript-closure';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'tri613-github-io' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>